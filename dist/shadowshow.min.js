"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var _ShadowPlay=require("./core/ShadowPlay.js"),_ShadowPlay2=_interopRequireDefault(_ShadowPlay);function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}"function"==typeof define&&define.amd&&define([],function(){return{ShadowPlay:_ShadowPlay2.default}}),"undefined"!=typeof exports&&(exports.ShadowPlay=_ShadowPlay2.default),"undefined"!=typeof window&&(window.ShadowPlay=_ShadowPlay2.default),exports.default=_ShadowPlay2.default,Object.defineProperty(exports,"__esModule",{value:!0});var _ShadowData=require("./ShadowData.js"),_ShadowData2=_interopRequireDefault(_ShadowData);function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}var shadowSymbol=Symbol("shadow"),DEFAULT_OPTIONS={elementAttributePrefix:"@",elementAttributes:{conditional:"if",loop:"each",click:"click",change:"change"},templateDef:{open:"{{",close:"}}"},debug:!1};function getWatchers(e,t){e=resolveWacherMapper(e);return e[t]=e[t]||new Set}function resolveWacherMapper(e){return resolveShadow(e).watcherMapper}function resolveShadow(e){if(e instanceof _ShadowData2.default)return e;var t=e[shadowSymbol];return t||(t=new _ShadowData2.default,e[shadowSymbol]=t),t}function resolveElement(e){return"string"==typeof e?document.querySelector(e):e}exports.default={shadowSymbol:shadowSymbol,getWatchers:getWatchers,resolveShadow:resolveShadow,resolveElement:resolveElement,DEFAULT_OPTIONS:DEFAULT_OPTIONS},Object.defineProperty(exports,"__esModule",{value:!0});var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},_Core=require("./Core.js"),_Core2=_interopRequireDefault(_Core);function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}var deepProxyTargetSymbol=Symbol("deep.proxy.target"),deepProxyTargetOriginalSymbol=Symbol("deep.proxy.target.original");function create(e,o,n,a,t,r){r=r||"";var l={set:function(e,t,r,o){return t!==deepProxyTargetSymbol&&t!==deepProxyTargetOriginalSymbol&&Reflect.set(e,t,r,o),!0},get:function(e,t,r){r=Reflect.get(e,t,r);return"object"!==(void 0===r?"undefined":_typeof(r))||null===r||t===deepProxyTargetSymbol||t===deepProxyTargetOriginalSymbol||a&&!a(t)?r:create(r,o,n,a,e,t)}};n&&n(e,t,r);r=new Proxy(e,o);e[deepProxyTargetOriginalSymbol]||(e[deepProxyTargetOriginalSymbol]=e);l=new Proxy(r,l);return l[deepProxyTargetSymbol]=e,l}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}exports.default={create:create},Object.defineProperty(exports,"__esModule",{value:!0});var ShadowData=function e(){_classCallCheck(this,e),this.watcherMapper={}};exports.default=ShadowData,Object.defineProperty(exports,"__esModule",{value:!0});var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},_createClass=function(){function o(e,t){for(var r=0;r<t.length;r++){var o=t[r];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(e,t,r){return t&&o(e.prototype,t),r&&o(e,r),e}}(),_RenderHelper=require("../renderer/RenderHelper.js"),_RenderHelper2=_interopRequireDefault(_RenderHelper),_DeepProxy=require("./DeepProxy.js"),_DeepProxy2=_interopRequireDefault(_DeepProxy),_Core=require("./Core.js"),_Core2=_interopRequireDefault(_Core);function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var defaultOptions={},ShadowPlay=function(){function o(e,t,r){_classCallCheck(this,o),this.app={data:e,ext:t},this.options=Object.assign({},_Core2.default.DEFAULT_OPTIONS,defaultOptions,r),r.debug&&console.log("ShadowPlay Debug Enabled.")}return _createClass(o,[{key:"isPossessed",value:function(e){return!!_Core2.default.resolveElement(e)[_Core2.default.shadowSymbol]}},{key:"possess",value:function(e){var u=this;if(e=_Core2.default.resolveElement(e),this.isPossessed(e))throw new Error("The element has been possessed!");return this.element=e,this.app.data=Object.assign({},this.app.data),this.data=_DeepProxy2.default.create(this.app.data,{set:function(e,t,r,o){var n=e[t];if(n!==(e[t]=r)){var a=[];"symbol"!==(void 0===t?"undefined":_typeof(t))&&"object"===(void 0===n?"undefined":_typeof(n))?a=copyShadowAndCollectUpdaters(n,r):(r=_Core2.default.resolveShadow(e),e=_Core2.default.getWatchers(r,t),u.options.debug&&(console.log((r.name?r.name+".":"")+t.toString()+" is changed."),console.log(e)),e&&(e.forEach||console.log("forEach is not function"),e.forEach(function(e){return a.push(e)})));for(var l=0;l<a.length;l++)a[l](u.data)}return!0},get:function(e,t,r){e=e[t];return e instanceof Function&&"valueOf"!==t&&"toString"!==t?e(u.data):e}},function(e,t,r){e=_Core2.default.resolveShadow(e);e.key=r,e.name=function(){if(!t)return r;var e=_Core2.default.resolveShadow(t);return(e.name?e.name+".":"")+r}()},function(e){return e!==_Core2.default.shadowSymbol}),_RenderHelper2.default.render(e,this.data,{},{debug:this.options.debug}),this}},{key:"process",value:function(e){return possess(e)}}],[{key:"create",value:function(e,t,r){return new o(e,t,r)}},{key:"config",value:function(e){Object.assign(defaultOptions,_Core2.default.DEFAULT_OPTIONS,e)}},{key:"resetConfig",value:function(){defaultOptions=Object.assign({},_Core2.default.DEFAULT_OPTIONS)}}]),o}();function copyShadowAndCollectUpdaters(e,t,r){r=r||[];var o,n,a=e[_Core2.default.shadowSymbol],l=a.watchers=a.watchers||{};for(o in l)l[o].forEach(function(e){return r.push(e)});for(n in t[_Core2.default.shadowSymbol]=e[_Core2.default.shadowSymbol],e)"symbol"!==(void 0===n?"undefined":_typeof(n))&&"object"===_typeof(e[n])&&r.push.apply(r,copyShadowAndCollectUpdaters(e[n],t[n]));return r}exports.default=ShadowPlay,Object.defineProperty(exports,"__esModule",{value:!0});var _createClass=function(){function o(e,t){for(var r=0;r<t.length;r++){var o=t[r];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(e,t,r){return t&&o(e.prototype,t),r&&o(e,r),e}}(),_NodeAttributeRenderer=require("./NodeAttributeRenderer.js"),_NodeAttributeRenderer2=_interopRequireDefault(_NodeAttributeRenderer);function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var IfRenderer=function(){function e(){return _classCallCheck(this,e),_possibleConstructorReturn(this,(e.__proto__||Object.getPrototypeOf(e)).apply(this,arguments))}return _inherits(e,_NodeAttributeRenderer2.default),_createClass(e,[{key:"render",value:function(){}}]),e}();exports.default=IfRenderer,Object.defineProperty(exports,"__esModule",{value:!0});_createClass=function(){function o(e,t){for(var r=0;r<t.length;r++){var o=t[r];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(e,t,r){return t&&o(e.prototype,t),r&&o(e,r),e}}(),_Core=require("../core/Core.js"),_Core2=_interopRequireDefault(_Core);function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var NodeAttributeRenderer=function(){function e(){_classCallCheck(this,e)}return _createClass(e,[{key:"createAnchor",value:function(){var e=document.createTextNode("");return e[_Core2.default.shadowSymbol]=el[_Core2.default.shadowSymbol],el.parentNode.insertBefore(e,el),e}}]),e}();exports.default=NodeAttributeRenderer,Object.defineProperty(exports,"__esModule",{value:!0});var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},_createClass=function(){function o(e,t){for(var r=0;r<t.length;r++){var o=t[r];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(e,t,r){return t&&o(e.prototype,t),r&&o(e,r),e}}(),_TextRenderer=require("./TextRenderer.js"),_TextRenderer2=_interopRequireDefault(_TextRenderer),_DeepProxy=require("../core/DeepProxy.js"),_DeepProxy2=_interopRequireDefault(_DeepProxy),_Core=require("../core/Core.js"),_Core2=_interopRequireDefault(_Core);function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var RenderHelper=function(){function e(){_classCallCheck(this,e)}return _createClass(e,null,[{key:"render",value:function(l,t,r,u){var i,o=this;function e(e){var t=l[_Core2.default.shadowSymbol],e=_DeepProxy2.default.create(e,{get:function(e,t,r){var o,n,a=e[t];return"symbol"!==(void 0===t?"undefined":_typeof(t))&&"object"!==(void 0===a?"undefined":_typeof(a))&&(o=_Core2.default.resolveShadow(e),n=_Core2.default.getWatchers(o,t),e=!1,u.debug&&(n.has(i)||(e=!0,console.log("adding watcher for "+(o.name?o.name+".":"")+t.toString()+":"),console.log(l))),n.add(i),u.debug&&e&&console.log(n)),a}},function(e){},function(e){return e!==_Core2.default.shadowSymbol});return(t.renderer=t.renderer||("#text"===l.nodeName?new _TextRenderer2.default({template:l.data,debug:u.debug}).complete(function(e){return l.data=e}):new NodeRenderer({template:l,debug:u.debug}))).render(e,r)}"#comment"===l.nodeName||"#text"===l.nodeName&&""===l.data||(r=r||{},u=u||{},l[_Core2.default.shadowSymbol]=l[_Core2.default.shadowSymbol]||{},(i=l[_Core2.default.shadowSymbol].updater=l[_Core2.default.shadowSymbol].updater||(u.debug&&(e.node=l,e.desc=l.nodeName+(l.id?"#"+l.id:"")),e))(t)&&l.childNodes&&l.childNodes.forEach(function(e){o.render(e,t,r,u)}))}}]),e}(),NodeRenderer=function(){function t(e){_classCallCheck(this,t),this.options=e||{}}return _createClass(t,[{key:"render",value:function(c,p){var y=this;return(this.fn=this.fn||function(){var r=y.options.template,t=r.getAttribute("@if");if(t){r.removeAttribute("@if");var o=r[_Core2.default.shadowSymbol].ifRenderer=r[_Core2.default.shadowSymbol].ifRenderer||new _TextRenderer2.default({template:t}),n=document.createTextNode("");n[_Core2.default.shadowSymbol]=r[_Core2.default.shadowSymbol],r.parentNode.insertBefore(n,r),"false"===o.render(c,p).trim()&&r.remove();return function(e,t){return"false"===o.render(e,t).trim()?(r.remove(),!1):(n.parentNode.insertBefore(r,n),!0)}}var a=r.getAttribute("@each")||r.getAttribute("@for");if(!a)return r.getAttribute("@href")&&new _TextRenderer2.default({template:r.getAttribute("@href")}).complete(function(e){r.href=e,r.removeAttribute("@href")}).render(c,p),function(){return!0};var e=document.createTextNode("");e[_Core2.default.shadowSymbol]=r[_Core2.default.shadowSymbol],r.parentNode.insertBefore(e,r),r.removeAttribute("@each"),r.removeAttribute("@for"),r.remove();var l=a.split(/\sin\s/),t=l[0],a=l[1],l="return data =>{\n    for(let i in data."+a+" ){\n        let "+t+" = data."+a+"[i];\n        let newEl = el.cloneNode(true);\n        author.parentNode.insertBefore(newEl, author);\n        RenderHelper.render(newEl, data, Object.assign({}, context, {"+t+":"+t+"}), options);\n    }\n    return false;\n}",u=!0,a=!1,t=void 0;try{for(var i,s=r.getAttributeNames()[Symbol.iterator]();!(u=(i=s.next()).done);u=!0){var f,d=i.value;/^@/.test(d)&&(f=r.getAttribute(d),r.removeAttribute(d),r.setAttribute(d.substring(1),f))}}catch(e){a=!0,t=e}finally{try{!u&&s.return&&s.return()}finally{if(a)throw t}}return new Function("context","el","data","RenderHelper","author","options",l)(p,r,c,RenderHelper,e,{debug:y.options.debug})}())(c,p)}}]),t}();exports.default=RenderHelper,Object.defineProperty(exports,"__esModule",{value:!0});_createClass=function(){function o(e,t){for(var r=0;r<t.length;r++){var o=t[r];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(e,t,r){return t&&o(e.prototype,t),r&&o(e,r),e}}();function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var TextNodeRenderer=function(){function t(e){_classCallCheck(this,t),this.options=e||{}}return _createClass(t,[{key:"render",value:function(e,t){var r,o=this.options.template,r=this.fn=this.fn||(r="    let p=[];\n    with(data){\n        with(context){\n            p.push('"+o.replace(/\n/g,"\\n").split(/{{/).join("');\n\t\tp.push(").split(/}}/).join(");\n\t\tp.push('")+"');\n\n        }\n    }\n    return p.join('');\n",new Function("data","context",r));try{var n=r(e,t);if(this.options.callbacks)for(var a=0;a<this.options.callbacks.length;a++)this.options.callbacks[a](n);return n}catch(e){console.log(e)}}},{key:"complete",value:function(e){return(this.options.callbacks=this.options.callbacks||[]).push(e),this}}]),t}();exports.default=TextNodeRenderer;